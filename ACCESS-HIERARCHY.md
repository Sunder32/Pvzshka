# Иерархия администраторов и доступов

## Структура ролей

### 1. **Global Admin** (Главный администратор платформы)
**Доступ:** http://localhost:3001

**Возможности:**
- ✅ Управление всеми тенантами (создание, редактирование, удаление)
- ✅ Просмотр и редактирование сайтов ВСЕХ тенантов через Site Builder
- ✅ Управление пользователями всей платформы
- ✅ Просмотр всех заявок в поддержку от всех тенантов
- ✅ Ответы на заявки и изменение их статуса
- ✅ Биллинг и тарифы для всех тенантов
- ✅ Генерация мобильных приложений
- ✅ Глобальные настройки платформы

**Меню:**
- Дашборд - общая статистика по платформе
- Тенанты - список всех магазинов
- Конструктор сайта - редактирование любого сайта
- **Поддержка** - все заявки от тенантов
- Пользователи - управление пользователями
- Биллинг - управление подписками
- Генератор приложений - создание мобильных приложений
- Настройки - глобальные настройки

---

### 2. **Tenant Admin** (Администратор магазина)
**Доступ:** http://localhost:3002

**Возможности:**
- ✅ Управление ТОЛЬКО своим магазином
- ✅ Редактирование сайта своего магазина через Site Builder
- ✅ Управление товарами, заказами, клиентами
- ✅ Просмотр аналитики своего магазина
- ✅ **Отправка заявок в техподдержку Global Admin**
- ✅ Просмотр своих заявок и переписка с поддержкой
- ❌ НЕ может видеть другие магазины
- ❌ НЕ может менять глобальные настройки

**Меню:**
- Дашборд - статистика магазина
- Товары - управление каталогом
- Заказы - обработка заказов
- Клиенты - база клиентов
- Аналитика - отчеты и графики
- **Конструктор сайта** - настройка внешнего вида своего магазина
- **Поддержка** - создание и просмотр заявок
- Настройки - настройки магазина

---

## Система поддержки

### Workflow заявок

1. **Tenant Admin создает заявку:**
   - Указывает тему, категорию (техническая/биллинг/функционал/другое)
   - Выбирает приоритет (низкий/средний/высокий/срочный)
   - Описывает проблему
   - Заявка автоматически получает статус "open"

2. **Global Admin получает уведомление:**
   - Видит заявку в разделе "Поддержка"
   - Может назначить заявку себе или другому администратору
   - Меняет статус на "in-progress" (в работе)

3. **Переписка:**
   - Tenant Admin и Global Admin общаются внутри заявки
   - Все сообщения сохраняются с меткой автора (тенант/админ)
   - Видна история всей переписки

4. **Решение:**
   - Global Admin решает проблему
   - Меняет статус на "resolved" (решено)
   - Заявка остается доступна для просмотра

5. **Закрытие:**
   - Опционально можно закрыть заявку (статус "closed")

### Категории заявок
- **technical** - Техническая проблема (ошибки, баги)
- **billing** - Вопросы по оплате и тарифам
- **feature** - Запрос нового функционала
- **other** - Другие вопросы

### Приоритеты
- **urgent** - Срочно (критичная проблема, сайт не работает)
- **high** - Высокий (важная проблема)
- **medium** - Средний (обычная проблема)
- **low** - Низкий (некритичная проблема)

---

## Site Builder - доступ по ролям

### Global Admin
**Может:**
- Редактировать сайт ЛЮБОГО тенанта
- Выбирает tenant_id в интерфейсе
- Публикует изменения для любого магазина
- Видит все сохраненные конфигурации

**GraphQL:**
```graphql
query {
  siteConfig(tenantId: "1") { ... }
  siteConfig(tenantId: "2") { ... }
  # Доступ к любому тенанту
}
```

### Tenant Admin
**Может:**
- Редактировать ТОЛЬКО свой сайт
- tenant_id определяется из JWT токена/сессии автоматически
- Публикует изменения только для своего магазина
- Видит только свои конфигурации

**GraphQL:**
```graphql
# tenant_id берется из контекста авторизации
query {
  siteConfig(tenantId: "{{ currentUserTenantId }}") { ... }
}
```

---

## База данных - изоляция тенантов

### Таблицы

**tenants** - список всех магазинов
- `id` - уникальный ID
- `subdomain` - поддомен (demo.marketplace.com)
- `name` - название магазина

**site_configs** - конфигурации сайтов
- `tenant_id` - FK на tenants (обязательный)
- Каждый тенант может иметь несколько конфигураций (draft/published/archived)

**support_tickets** - заявки в поддержку
- `tenant_id` - FK на tenants
- `subject`, `category`, `priority`, `status`
- `assigned_to` - кому назначена заявка

**ticket_messages** - сообщения в заявках
- `ticket_id` - FK на support_tickets
- `author_type` - 'tenant' или 'admin'

### Row Level Security (RLS) - будущее улучшение

```sql
-- Tenant Admin видит только свои данные
CREATE POLICY tenant_isolation ON site_configs
  FOR ALL TO tenant_admin
  USING (tenant_id = current_setting('app.current_tenant_id')::integer);

-- Global Admin видит все
CREATE POLICY global_admin_all ON site_configs
  FOR ALL TO global_admin
  USING (true);
```

---

## Установка и запуск

### 1. База данных

```bash
# Создать БД
psql -U postgres -c "CREATE DATABASE marketplace;"

# Применить миграции
psql -U postgres -d marketplace -f Backend/scripts/site-builder-schema.sql
psql -U postgres -d marketplace -f Backend/scripts/support-tickets-schema.sql
```

### 2. Config Service (GraphQL)

```bash
cd Backend/config-service
npm install

# Создать .env
PORT=4000
DB_HOST=localhost
DB_PORT=5432
DB_NAME=marketplace
DB_USER=postgres
DB_PASSWORD=postgres

# Запустить
npm run dev
```

GraphQL Playground: http://localhost:4000/graphql

### 3. Global Admin

```bash
cd Frontend/global-admin
npm install
npm start
```

Откроется: http://localhost:3001

**Вход:** admin@example.com / admin123

### 4. Tenant Admin

```bash
cd Frontend/tenant-admin
npm install
npm run dev
```

Откроется: http://localhost:3002

**Вход:** tenant@demo.com / demo123

---

## Примеры использования

### Tenant Admin - создание заявки

1. Войти как tenant@demo.com
2. Перейти в "Поддержка"
3. Нажать "Создать заявку"
4. Заполнить:
   - Тема: "Не загружаются изображения"
   - Категория: Техническая проблема
   - Приоритет: Высокий
   - Описание: "При загрузке фото товара появляется ошибка 500"
5. Отправить

### Global Admin - обработка заявки

1. Войти как admin@example.com
2. Перейти в "Поддержка"
3. Увидеть новую заявку от Demo Store
4. Открыть заявку
5. Нажать "Взять в работу" (статус → in-progress)
6. Написать ответ: "Проверяем, укажите размер файла"
7. Отправить
8. После решения нажать "Пометить как решенное"

### Tenant Admin - редактирование сайта

1. Войти как tenant@demo.com
2. Перейти в "Конструктор сайта"
3. Изменить цвета темы
4. Добавить секцию "Hero"
5. Настроить заголовок и подзаголовок
6. Нажать "Сохранить" (черновик)
7. Предпросмотреть в разных режимах
8. Нажать "Опубликовать"

### Global Admin - редактирование любого сайта

1. Войти как admin@example.com
2. Перейти в "Конструктор сайта"
3. Выбрать tenant_id: 1 (Demo Store) или 2 (Tech Shop)
4. Редактировать сайт выбранного тенанта
5. Опубликовать изменения

---

## Безопасность

### Текущая реализация (demo)
- ❌ Без реальной аутентификации
- ❌ Без JWT токенов
- ❌ Без проверки прав доступа в GraphQL

### Необходимо добавить (production)
- ✅ JWT авторизация с ролями (global_admin / tenant_admin)
- ✅ Middleware в GraphQL для проверки прав
- ✅ RLS в PostgreSQL для изоляции данных
- ✅ HTTPS для всех соединений
- ✅ Rate limiting для API
- ✅ Логирование всех действий администраторов

### Пример защиты resolvers

```javascript
// resolvers.js
export const resolvers = {
  Query: {
    siteConfig: async (_, { tenantId }, context) => {
      const { user } = context;
      
      // Tenant Admin может смотреть только свой сайт
      if (user.role === 'tenant_admin' && user.tenantId !== tenantId) {
        throw new GraphQLError('Access denied');
      }
      
      // Global Admin может смотреть все
      if (user.role === 'global_admin') {
        return getSiteConfig(tenantId);
      }
      
      return getSiteConfig(tenantId);
    }
  }
};
```

---

## Next Steps

- [ ] Добавить JWT аутентификацию
- [ ] Реализовать RLS в PostgreSQL
- [ ] Добавить email уведомления о новых заявках
- [ ] Добавить вложения в заявки (скриншоты)
- [ ] Создать систему приоритизации заявок
- [ ] Добавить SLA для заявок (время ответа)
- [ ] Интегрировать с внешними системами (Intercom, Zendesk)
- [ ] Добавить поиск и фильтрацию заявок
- [ ] Статистика по заявкам (время решения, CSAT)
